<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script> 
</head>
<body 
style="background-color:rgb(68, 88, 188); 
font-size: 30px; font-family: 'Noto Sans', sans-serif;
line-height: 0px; "
>

    <p><center>DCI Drone Map</center></p>
    
    <script type="module">
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.4/firebase-app.js";
        import {getDatabase, ref, onValue} from "https://www.gstatic.com/firebasejs/9.6.4/firebase-database.js"
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
    apiKey: "AIzaSyCnmmhQSrfehYzj-6r9hPmMmFGaf7JuHVk",
    authDomain: "dronesimdata.firebaseapp.com",
    databaseURL: "https://dronesimdata-default-rtdb.firebaseio.com",
    projectId: "dronesimdata",
    storageBucket: "dronesimdata.appspot.com",
    messagingSenderId: "1085494560362",
    appId: "1:1085494560362:web:39f112434c42059fe4ac13",
    measurementId: "G-Q6SEY255MQ",
    //databaseURL: "https://dronesimdata-default-rtdb.firebaseio.com/"
    };

// Initialize Firebase
    


    var config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 200 }
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        },
        
        
    };

    var game = new Phaser.Game(config);
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const playerList = []
    var playerSprite
    var currentInfoDisplay = -1;
    var text;
  
    const player1CoordPair = [];
    const player2CoordPair = [];

    var alertTextList = [];
    function preload ()
    {
        this.load.setBaseURL('http://labs.phaser.io');

        this.load.image('sky', 'assets/skies/space3.png');
        this.load.image('logo', 'assets/sprites/phaser3-logo.png');
        this.load.image('red', 'assets/particles/red.png');
        this.load.image('drone', 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR6DvUDwMyg8ko3mosvekw3vnnedJflwdRCEQ&usqp=CAU');
        this.load.image('unknownDrone', 'https://static.vecteezy.com/system/resources/previews/014/989/719/original/question-mark-hand-drawn-doodle-faq-symbol-free-vector.jpg');
        this.load.image('background', 'https://elements-video-cover-images-0.imgix.net/files/ccbac118-2c67-4e45-bda1-5d5d9233d46d/inline_image_preview.jpg?auto=compress%2Cformat&fit=min&h=394&w=700&s=f709897523fbe62bb21d1f7f442f934b')
        //this.load.image('player', 'https://media.istockphoto.com/id/1130455739/vector/sketch-smartphone-the-phone-is-isolated-on-a-white-background-vector-illustration.jpg?s=612x612&w=0&k=20&c=1haz05V1oS6FtmV_BAtVCAd7yUOj_NOact_2dDRiNO4=')
    }


    function create ()
    {
        var background = this.add.image(window.innerWidth/2.2,window.innerHeight/2.2, 'background');
        background.setScale(5);
        //this.add.image(1000, 800, 'sky');
        text = this.add.text(( 100),100,"", {font: "350% Arial", color: "#3CB043", align: "center", backgroundColor:"#FFFFFF"});
        
        //var particles = this.add.particles('red');

        // var emitter = particles.createEmitter({
        //     speed: 100,
        //     scale: { start: 1, end: 0 },
        //     blendMode: 'ADD'
        // });

        //var logo = this.physics.add.image(400, 100, 'logo');
        // logo.setVelocity(100, 200);
        // logo.setBounce(1, 1);
        // logo.setCollideWorldBounds(true);

        // emitter.startFollow(logo);
        for(var i = 0; i<11; i++){
            playerList[i] = this.add.sprite(0,0, 'drone').setInteractive();
            playerList[i].setScale(.3)  
        }
        //this.add.sprite(200,200,'player').setScale(.15);

        player1CoordPair[0] = .5*window.innerWidth;
        player1CoordPair[1] = .7*window.innerHeight;
        player1CoordPair[2] = Math.sqrt(window.innerWidth*window.innerHeight)/5;

        player2CoordPair[0] = .2*window.innerWidth;
        player2CoordPair[1] = .2*window.innerHeight;
        player2CoordPair[2] = Math.sqrt(window.innerWidth*window.innerHeight)/5;
       
        var c1 = this.add.circle(player2CoordPair[0],player2CoordPair[1],player2CoordPair[2],0x7FF837,.1)
        var c2 = this.add.circle(player1CoordPair[0],player1CoordPair[1], player1CoordPair[2], 0x464DFD, .2)


        var c4 = this.add.circle(player1CoordPair[0],player1CoordPair[1], player1CoordPair[2]/7, 0xFFFFFF)
        var c3 = this.add.circle(player1CoordPair[0],player1CoordPair[1], player1CoordPair[2]/8, 0x464DFD, 1)

        var c3 = this.add.circle(player2CoordPair[0],player2CoordPair[1], player2CoordPair[2]/8, 0x7FF837, .6)

        //playerSprite = this.add.sprite(500,550,'player');
        //playerSprite.setScale(.15);
        
            playerList[0].on('pointerdown', function(){
                currentInfoDisplay = 0;
            });
            playerList[1].on('pointerdown', function(){
                currentInfoDisplay = 1;
            });
            playerList[2].on('pointerdown', function(){
                currentInfoDisplay = 2;
            });
            playerList[3].on('pointerdown', function(){
                currentInfoDisplay = 3;
            });
            playerList[4].on('pointerdown', function(){
                currentInfoDisplay = 4;
            });
            playerList[5].on('pointerdown', function(){
                currentInfoDisplay = 5;
            });
            playerList[6].on('pointerdown', function(){
                currentInfoDisplay = 6;
            });
            playerList[7].on('pointerdown', function(){
                currentInfoDisplay = 7;
            });
            playerList[8].on('pointerdown', function(){
                currentInfoDisplay = 8;
            });
            playerList[9].on('pointerdown', function(){
                currentInfoDisplay = 9;
            });
            playerList[10].on('pointerdown', function(){
                currentInfoDisplay = 10;
            });
        
        //var topLeft = this.add.sprite(0,0,'drone');
         //var topRight = this.add.sprite(950,0,'drone');
         //var botLeft = this.add.sprite(0,750,'drone');
          //var botRight = this.add.sprite(1000,800,'drone');
        //playerList.setCollideWorldBounds(true);
    }
    var ticker = 0;
    
    
    function update(){
        
        ticker++;
        if(ticker%12==0){
            //text.destroy();
            for(var i = 0; i<11; i++){
            const r = ref(database, '/drones/'+i);
            onValue(r, (snapshot) => {
                const x =  (snapshot.val().position.x)/100 * window.innerWidth;
                const y = (snapshot.val().position.y)/100 * window.innerHeight;
                if(x!=undefined && y!=undefined){
                    //console.log(x+500+" "+y);
                    playerList[i].setPosition(x,y);
                }
                //console.log(currentInfoDisplay);
                //if(text){text.destroy()}
                if(i==currentInfoDisplay){
                    
                    text.setPosition(x-30, y+35)
                    text.setText("ID: "+snapshot.val().name+"\nx: "+Math.floor(x)+", y: "+Math.floor(y))
                    //console.log("displayed")
                }
            //console.log(data);
        });
        }
        //console.log("hi");
    }

    var numDrones = 0;
    alertTextList.forEach(function (value) {
        value.setVisible(false);
    }); 

    for(var i = 0; i<11; i++){
        if(Math.sqrt(Math.pow(player1CoordPair[0]-playerList[i].x, 2) + Math.pow(player1CoordPair[1]-playerList[i].y, 2))<player1CoordPair[2] ||
        Math.sqrt(Math.pow(player2CoordPair[0]-playerList[i].x, 2) + Math.pow(player2CoordPair[1]-playerList[i].y, 2))<player2CoordPair[2]){
            playerList[i].setTexture('drone')
            playerList[i].setScale(.3)
            alertTextList.push(this.add.text(window.innerWidth*.7,window.innerHeight*0+(numDrones*20),"Alert: Drone approaching", {font: "250% Arial", color: "#f51073", align: "center", backgroundColor:"#FFFFFF"}));
            numDrones++;
        } else{
            //console.log("outta range")
            playerList[i].setTexture('unknownDrone');
            playerList[i].setScale(.02)
            if(currentInfoDisplay == i){
                currentInfoDisplay = -1;
                text.setPosition(-100,-100)
            }
        }
    }
}
    </script>

</body>
</html>